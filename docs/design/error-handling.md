# Draftify 에러 핸들링

**버전**: 1.4
**최종 갱신**: 2025-12-29
**관련 문서**: config.md (설정값), workflow.md (워크플로우)

---

## 목차

1. [에러 핸들링 철학](#1-에러-핸들링-철학)
2. [재시도 전략](#2-재시도-전략)
3. [연쇄 실패 차단 (Circuit Breaker)](#3-연쇄-실패-차단-circuit-breaker)
4. [Phase별 에러 핸들링](#4-phase별-에러-핸들링)
5. [에러 메시지 정의](#5-에러-메시지-정의)

---

## 1. 에러 핸들링 철학

Draftify는 **부분 성공 허용 (Graceful Degradation)** 원칙을 따릅니다.

### 핵심 원칙

| 원칙 | 설명 |
|------|------|
| **필수 Phase 보호** | Phase 1-2 실패 시 전체 중단 |
| **선택 Phase 유연성** | Phase 3-4 실패 시 부분 성공 허용 |
| **최소 산출물 보장** | 최악의 경우에도 마크다운 섹션 제공 |
| **사용자 피드백** | 실패 원인 및 복구 방법 안내 |

### 에이전트 중요도

| 중요도 | 에이전트 | 실패 시 동작 |
|--------|---------|-------------|
| **Critical** | input-analyzer | 전체 워크플로우 중단 |
| **High** | screen-generator, policy-generator | 재시도 후 빈 섹션으로 대체 |
| **Medium** | glossary-generator, process-generator | 재시도 후 빈 섹션으로 대체 |
| **Low** | quality-validator | 재시도 없음, FAIL로 계속 진행 |

---

## 2. 재시도 전략

> **Note**: 재시도 횟수 및 타임아웃 수치는 [config.md](./config.md) 참조

### 재시도 조건

| 에이전트 | 재시도 조건 | 실패 시 동작 |
|---------|-----------|------------|
| input-analyzer | 타임아웃, 파싱 에러 | **전체 중단** |
| policy-generator | 타임아웃, JSON 에러 | 빈 정책 섹션 생성 |
| glossary-generator | 타임아웃 | 빈 용어집 생성 |
| screen-generator | 타임아웃, 이미지 로드 실패 | 텍스트만 생성 |
| process-generator | 타임아웃 | 빈 프로세스 섹션 생성 |
| quality-validator | - | 재시도 없음, FAIL 리포트 생성 |

### 백오프 전략

- **방식**: 지수 백오프 (Exponential Backoff)
- **간격**: 5초 → 10초 → 20초
- **최대 대기**: 20초

---

## 3. 연쇄 실패 차단 (Circuit Breaker)

동일 유형의 실패가 연속으로 발생하면 **실패 확산을 방지하기 위해 자동 중단**한다.

### 트리거 조건
- 동일 Phase에서 **연속 실패 2회** 발생 (재시도 한도 소진 후 실패 기준)

### 적용 규칙
- **Phase 1-2 (필수)**: Circuit Breaker 발동 시 전체 워크플로우 중단
- **Phase 3-4 (선택)**: Circuit Breaker 발동 시 해당 Phase의 잔여 작업 중단, 경고 포함 후 다음 Phase로 진행

### 기록
- 발동 시점과 대상 Phase를 로그에 기록
- 사용자에게 원인 및 재실행 가이드 안내

---

## 4. Phase별 에러 핸들링

### Phase 1: 입력 수집

#### URL 접속 실패

```
에러: URL에 접근할 수 없습니다.
원인: 404, 500, 타임아웃, 네트워크 오류

처리:
1. 3회 재시도
2. 실패 시 --screenshots 옵션 확인
3. 스크린샷 제공되면 URL 없이 진행
4. 둘 다 없으면 → 중단
```

#### 불충분한 페이지 발견

```
조건: 발견된 페이지 < 3개

처리:
1. 경고 메시지 표시
2. Record 모드, --urls, --source-dir 옵션 안내
3. 옵션 없이 실행된 경우 → 중단
4. 옵션 제공된 경우 → 계속 진행
```

#### Hash 라우팅 SPA 감지

```
조건: <a href="#/path"> 형태 링크 발견 + 일반 링크 < 3개

처리:
1. SPA 감지 경고 표시
2. Record 모드 사용 권장
3. Record 모드 아닌 경우 → 중단
4. Record 모드인 경우 → 계속 진행
```

#### 일부 페이지 크롤링 실패

```
처리:
1. 실패 페이지 스킵
2. 최소 1개 성공 시 → 계속 진행
3. 모든 페이지 실패 시 → 중단
```

#### 파일 읽기 실패 (PRD, SDD 등)

```
처리:
1. 해당 파일 스킵 (선택 입력이므로)
2. 로그에 경고 기록
3. 계속 진행
```

---

### Phase 2: 분석

#### input-analyzer 실패

```
에러: analyzed-structure.json 생성 실패

처리:
1. 최대 3회 재시도
2. 재시도 후에도 실패 → 전체 중단
3. 사용자에게 입력 데이터 검토 요청
```

#### 부분 분석 성공

```
조건: 일부 섹션만 추출 성공 (예: 화면은 OK, 정책은 실패)

처리:
1. 가능한 섹션만 포함하여 진행
2. validation-report에 누락 사항 기록
```

---

### Phase 3-1: 정책/용어 생성

#### policy-generator 실패

```
처리:
1. 3회 재시도
2. 실패 시:
   - 빈 정책 섹션 생성 (제목만)
   - Phase 3-2 계속 진행 (정책 ID 참조 없이)
   - validation-report에 FAIL 기록
```

#### glossary-generator 실패

```
처리:
1. 2회 재시도
2. 실패 시: 빈 용어집 생성
3. 진행에 큰 영향 없음 (독립 섹션)
```

---

### Phase 3-2: 화면/프로세스 생성

#### screen-generator 실패

```
처리:
1. 3회 재시도
2. 실패 시:
   - 빈 화면 섹션 생성
   - process-generator는 analyzed-structure.json 직접 참조로 진행
```

#### process-generator 실패

```
처리:
1. 2회 재시도
2. 실패 시: 빈 프로세스 섹션 생성
```

#### 모두 실패

```
처리:
1. Phase 3-1 결과만으로 진행
2. 최소 구성: 정책 + 용어집만 포함
```

---

### Phase 3.5: 검증

#### quality-validator 실패

```
처리:
1. 재시도 없음 (검증은 optional)
2. validation-report 없이 Phase 4 진행
```

#### validation 결과 FAIL

```
처리:
1. FAIL이어도 Phase 4 진행
2. validation-report를 결과에 포함
3. 사용자에게 수정 후 재실행 권장
```

---

### Phase 4: 문서 생성

#### PPT 생성 실패

```
처리:
1. HTML 대체 버전 생성 시도
2. HTML도 실패 시: 마크다운 파일들만 제공
3. sections/ 디렉토리는 항상 존재 보장
```

#### 스크린샷 임베딩 실패

```
처리:
1. 이미지 경로만 텍스트로 표시
2. 계속 진행
```

---

## 5. 에러 메시지 정의

### Critical 에러 (워크플로우 중단)

| 에러 코드 | 메시지 | 사용자 조치 |
|----------|--------|------------|
| `E_URL_UNREACHABLE` | URL에 접근할 수 없습니다 | URL 확인, Record 모드 시도 |
| `E_NO_PAGES` | 크롤링 가능한 페이지가 없습니다 | --urls 또는 --source-dir 제공 |
| `E_ANALYSIS_FAILED` | 분석 데이터를 생성할 수 없습니다 | 입력 파일 확인 후 재시도 |

### Warning (계속 진행)

| 에러 코드 | 메시지 | 영향 |
|----------|--------|------|
| `W_PARTIAL_CRAWL` | 일부 페이지 크롤링 실패 | 해당 페이지 제외 |
| `W_FILE_NOT_FOUND` | 선택 파일을 찾을 수 없습니다 | 해당 파일 스킵 |
| `W_SECTION_FAILED` | {섹션} 생성 실패 | 빈 섹션으로 대체 |
| `W_VALIDATION_FAIL` | 품질 검증 실패 | 결과에 경고 포함 |

### Info (참고)

| 에러 코드 | 메시지 |
|----------|--------|
| `I_SPA_DETECTED` | SPA가 감지되었습니다. Record 모드를 권장합니다 |
| `I_FALLBACK_HTML` | PPT 생성 실패, HTML로 대체합니다 |
| `I_PARTIAL_SUCCESS` | 일부 섹션만 생성되었습니다 |

---

## 변경 이력

| 버전 | 날짜 | 변경 내용 |
|------|------|----------|
| 1.4 | 2025-12-29 | 문서 정리: Skill/오케스트레이션 코드 제거, 설정값은 config.md 참조 |
| 1.3 | 2025-12-29 | Phase 3-1 병렬 실행 반영 |
| 1.0 | 2025-12-27 | 초기 작성 |
